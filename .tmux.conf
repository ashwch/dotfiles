# ╔══════════════════════════════════════════════════════════════════════════╗
# ║                                                                          ║
# ║   tmux configuration                                                     ║
# ║   Hybrid Ghostty + tmux setup                                            ║
# ║                                                                          ║
# ║   https://github.com/ashwch/dotfiles                                     ║
# ║                                                                          ║
# ╚══════════════════════════════════════════════════════════════════════════╝
#
# STRATEGY:
#   Ghostty handles tabs and windows (Cmd+T, Cmd+N, Cmd+1-9)
#   tmux handles panes within each tab (with session persistence)
#
# This gives you the best of both worlds:
#   - Native macOS experience for window/tab management
#   - Session persistence that survives terminal crashes
#   - Familiar keyboard shortcuts that match Ghostty native
#
# QUICK START:
#   Prefix key is Ctrl-a (more ergonomic than default Ctrl-b)
#   Most common shortcuts work without prefix (Cmd+D, Cmd+W, etc.)
#
# ─────────────────────────────────────────────────────────────────────────────


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Prefix Key                                                               │
# └──────────────────────────────────────────────────────────────────────────┘

# Use Ctrl-a instead of Ctrl-b (easier to reach)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Double-tap Ctrl-a to switch to last pane (very useful!)
bind -r C-a last-pane


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ General Settings                                                         │
# └──────────────────────────────────────────────────────────────────────────┘

# Terminal settings
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"        # True color support
set -ga terminal-overrides ",xterm-ghostty:Tc"   # Ghostty-specific true color

# Mouse support (scrolling, clicking, resizing, selection)
set -g mouse on

# Copy to system clipboard immediately when mouse selection ends
# This makes tmux copy feel native while respecting pane boundaries
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"

# Scrollback buffer (1 million lines for "infinite" scroll)
set -g history-limit 1000000

# Start numbering at 1 (easier to reach on keyboard)
set -g base-index 1
set -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Enable system clipboard integration
set -g set-clipboard on

# No delay for escape key (important for Vim users)
set -g escape-time 0

# Enable focus events (needed for some Vim plugins)
set -g focus-events on

# How long to display messages
set -g display-time 2000


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Ghostty Integration                                                      │
# │                                                                          │
# │ These bindings make tmux respond to Ghostty's native keyboard shortcuts. │
# │ Ghostty sends escape sequences which tmux interprets as user-defined     │
# │ keys, making the experience feel native.                                 │
# └──────────────────────────────────────────────────────────────────────────┘

# Register escape sequences from Ghostty as user-defined keys
set -s user-keys[0] "\e[1;2P"    # Cmd+D
set -s user-keys[1] "\e[1;2Q"    # Cmd+Shift+D
set -s user-keys[2] "\e[1;2R"    # Cmd+Option+Left
set -s user-keys[3] "\e[1;2S"    # Cmd+Option+Right
set -s user-keys[4] "\e[1;6P"    # Cmd+Option+Up
set -s user-keys[5] "\e[1;6Q"    # Cmd+Option+Down
set -s user-keys[6] "\e[1;6R"    # Cmd+W
set -s user-keys[7] "\e[1;6S"    # Cmd+Shift+Enter
set -s user-keys[8] "\e[1;7P"    # Cmd+Ctrl+Left
set -s user-keys[9] "\e[1;7Q"    # Cmd+Ctrl+Right
set -s user-keys[10] "\e[1;7R"   # Cmd+Ctrl+Up
set -s user-keys[11] "\e[1;7S"   # Cmd+Ctrl+Down

# Bind user keys to tmux actions
bind -n User0 split-window -h -c "#{pane_current_path}"   # Cmd+D: Split right
bind -n User1 split-window -v -c "#{pane_current_path}"   # Cmd+Shift+D: Split down
bind -n User2 select-pane -L                               # Cmd+Option+Left
bind -n User3 select-pane -R                               # Cmd+Option+Right
bind -n User4 select-pane -U                               # Cmd+Option+Up
bind -n User5 select-pane -D                               # Cmd+Option+Down
bind -n User6 kill-pane                                    # Cmd+W: Close pane
bind -n User7 resize-pane -Z                               # Cmd+Shift+Enter: Zoom
bind -n User8 resize-pane -L 5                             # Cmd+Ctrl+Left: Resize
bind -n User9 resize-pane -R 5                             # Cmd+Ctrl+Right: Resize
bind -n User10 resize-pane -U 5                            # Cmd+Ctrl+Up: Resize
bind -n User11 resize-pane -D 5                            # Cmd+Ctrl+Down: Resize


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Pane Splitting                                                           │
# └──────────────────────────────────────────────────────────────────────────┘

# Intuitive split keys (with prefix)
bind | split-window -h -c "#{pane_current_path}"    # | for vertical split
bind \\ split-window -h -c "#{pane_current_path}"   # \ as alternative
bind - split-window -v -c "#{pane_current_path}"    # - for horizontal split
bind _ split-window -v -c "#{pane_current_path}"    # _ as alternative


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Pane Navigation                                                          │
# └──────────────────────────────────────────────────────────────────────────┘

# Vim-style navigation (with prefix)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Alt+Arrow keys (no prefix needed)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Pane Resizing                                                            │
# └──────────────────────────────────────────────────────────────────────────┘

# Shift+Arrow keys for fine control (no prefix, 2 cells at a time)
bind -n S-Left resize-pane -L 2
bind -n S-Right resize-pane -R 2
bind -n S-Up resize-pane -U 2
bind -n S-Down resize-pane -D 2

# Vim-style with prefix (larger increments, 5 cells at a time)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Window Management                                                        │
# │ (Minimal - Ghostty handles tabs, but these are useful fallbacks)         │
# └──────────────────────────────────────────────────────────────────────────┘

# Create new window in same directory
bind c new-window -c "#{pane_current_path}"

# Close pane/window
bind x kill-pane
bind X kill-window

# Quick window switching with Alt+number
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Session Management                                                       │
# └──────────────────────────────────────────────────────────────────────────┘

bind S choose-session                           # Session picker
bind N new-session                              # New session
bind R command-prompt "rename-session '%%'"     # Rename session
bind D detach-client                            # Detach


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Copy Mode (Vi-style)                                                     │
# └──────────────────────────────────────────────────────────────────────────┘

# Use vi keys in copy mode
setw -g mode-keys vi

# Enter copy mode with Enter key
bind Enter copy-mode

# Vi-style selection and copying
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Escape send -X cancel

# Mouse selection
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send -X select-word
bind -T copy-mode-vi TripleClick1Pane select-pane \; send -X select-line


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Utility Bindings                                                         │
# └──────────────────────────────────────────────────────────────────────────┘

# Reload config
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Show all keybindings
bind ? list-keys

# Toggle pane zoom (fullscreen)
bind z resize-pane -Z

# Cycle through layouts
bind Space next-layout

# Even layouts
bind = select-layout even-horizontal
bind + select-layout even-vertical

# Synchronize panes (type in all panes at once)
bind a setw synchronize-panes \; display-message "Sync #{?synchronize-panes,ON,OFF}"

# Clear screen and history
bind C-l send-keys C-l \; clear-history


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Status Bar                                                               │
# │ Minimal design since Ghostty handles tabs                                │
# │ Theme: Gruvbox                                                           │
# └──────────────────────────────────────────────────────────────────────────┘

# Position and base style
set -g status-position bottom
set -g status-style "bg=default,fg=#928374"
set -g status-left-length 40
set -g status-right-length 60

# Left side: session name
set -g status-left "#[fg=#83a598,bold] #S #[fg=#504945]│ "

# Right side: user@host and time
set -g status-right "#[fg=#504945]│ #[fg=#d5c4a1]#(whoami)@#h #[fg=#504945]│ #[fg=#fabd2f]%H:%M "

# Window tabs (minimal since Ghostty handles main tabs)
set -g window-status-format "#[fg=#665c54] #I:#W "
set -g window-status-current-format "#[fg=#fe8019,bold] #I:#W "
set -g window-status-separator ""

# Pane borders
set -g pane-border-style "fg=#504945"
set -g pane-active-border-style "fg=#83a598"

# Messages
set -g message-style "bg=#3c3836,fg=#ebdbb2"

# Clock
set -g clock-mode-colour "#fabd2f"


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Automatic Naming                                                         │
# └──────────────────────────────────────────────────────────────────────────┘

# Auto-rename windows based on current command/directory
set -g automatic-rename on
set -g automatic-rename-format "#{?#{==:#{pane_current_command},zsh},#{b:pane_current_path},#{pane_current_command}}"


# ┌──────────────────────────────────────────────────────────────────────────┐
# │ Plugins (via TPM)                                                        │
# │                                                                          │
# │ Install: Ctrl-a I    Update: Ctrl-a U    Clean: Ctrl-a Alt-u            │
# └──────────────────────────────────────────────────────────────────────────┘

# Plugin manager
set -g @plugin 'tmux-plugins/tpm'

# Session persistence (survives reboots)
# Save: Ctrl-a Ctrl-s    Restore: Ctrl-a Ctrl-r
set -g @plugin 'tmux-plugins/tmux-resurrect'

# Auto-save sessions every 15 minutes
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'           # Auto-restore on tmux start

# Copy any visible text with fzf (Ctrl-a Tab)
set -g @plugin 'laktak/extrakto'
set -g @extrakto_key 'Tab'
set -g @extrakto_copy_key 'enter'
set -g @extrakto_insert_key 'tab'

# Quick copy with hints (Ctrl-a Space for thumbs)
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @thumbs-key 'Space'
set -g @thumbs-command 'echo -n {} | pbcopy'
set -g @thumbs-upcase-command 'echo -n {} | pbcopy'

# Initialize TPM (keep this at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'


# ╔══════════════════════════════════════════════════════════════════════════╗
# ║ Quick Reference                                                          ║
# ╚══════════════════════════════════════════════════════════════════════════╝
#
# GHOSTTY-STYLE (no prefix needed):
#   Cmd+D               Split right (vertical)
#   Cmd+Shift+D         Split down (horizontal)
#   Cmd+Option+Arrow    Navigate panes
#   Cmd+Ctrl+Arrow      Resize panes
#   Cmd+W               Close pane
#   Cmd+Shift+Enter     Toggle zoom
#
# NO-PREFIX ALTERNATIVES:
#   Alt+Arrow           Navigate panes
#   Shift+Arrow         Resize panes (fine control)
#
# PREFIX SHORTCUTS (Ctrl-a + key):
#   Ctrl-a Ctrl-a       Switch to last pane
#   Ctrl-a |            Split right
#   Ctrl-a -            Split down
#   Ctrl-a h/j/k/l      Navigate (vim-style)
#   Ctrl-a H/J/K/L      Resize (vim-style)
#   Ctrl-a z            Toggle zoom
#   Ctrl-a x            Close pane
#
# SESSIONS:
#   Ctrl-a d            Detach
#   Ctrl-a S            Session picker
#   Ctrl-a N            New session
#   Ctrl-a $            Rename session
#
# COPY MODE:
#   Ctrl-a Enter        Enter copy mode
#   v                   Begin selection
#   y                   Copy to clipboard
#   Escape              Exit copy mode
#
#   Navigation (in copy mode):
#   j/k or arrows       Move line by line
#   h/l                 Move character by character
#   w/b                 Move word forward/backward
#   Ctrl-u/d            Half page up/down
#   Ctrl-b/f            Full page up/down
#   g/G                 Top/bottom of buffer
#   /                   Search forward
#   ?                   Search backward
#   n/N                 Next/previous match
#
# UTILITY:
#   Ctrl-a r            Reload config
#   Ctrl-a ?            Show all bindings
#   Ctrl-a a            Toggle sync panes
#
# PLUGINS:
#   Ctrl-a Ctrl-s       Save session (resurrect)
#   Ctrl-a Ctrl-r       Restore session (resurrect)
#   Ctrl-a Tab          Copy with fzf (extrakto)
#   Ctrl-a Space        Copy with hints (thumbs)
#   Ctrl-a I            Install plugins
#   Ctrl-a U            Update plugins
#
# vim: ft=tmux
