#!/bin/bash
# Smart tmux session launcher for Ghostty
# - Shows existing sessions via fzf
# - Allows creating new sessions with custom names
# - Attaches to selected session or creates new one

# Use full paths since this runs before shell init
TMUX="/opt/homebrew/bin/tmux"
FZF="/opt/homebrew/bin/fzf"

# Get existing sessions
get_sessions() {
    $TMUX list-sessions -F "#{session_name}" 2>/dev/null
}

# Build the selection list
build_list() {
    echo "[+] Create new session"
    get_sessions | while read -r session; do
        # Get window count and current path for context
        info=$($TMUX list-windows -t "$session" -F "#{window_name}" 2>/dev/null | head -1)
        echo "$session ($info)"
    done
}

# Prompt user with fzf
selection=$(build_list | $FZF \
    --height=40% \
    --layout=reverse \
    --border=rounded \
    --prompt="tmux session > " \
    --header="Select session or create new" \
    --print-query \
    --bind="enter:accept" \
    --expect=enter)

# Parse fzf output (query on first line, key on second, selection on third)
query=$(echo "$selection" | sed -n '1p')
key=$(echo "$selection" | sed -n '2p')
choice=$(echo "$selection" | sed -n '3p')

# Handle selection
if [[ -z "$choice" && -z "$query" ]]; then
    # User cancelled - start default session
    exec $TMUX new-session -A -s "main"
elif [[ "$choice" == "[+] Create new session" || -z "$choice" ]]; then
    # Create new session with query as name (or prompt if empty)
    if [[ -n "$query" ]]; then
        session_name="$query"
    else
        # Default to directory-based name
        if [[ "$PWD" == "$HOME" ]]; then
            session_name="main"
        else
            session_name=$(basename "$PWD")
        fi
    fi
    # Sanitize
    session_name="${session_name//./-}"
    session_name="${session_name//:/-}"
    exec $TMUX new-session -A -s "$session_name"
else
    # Attach to existing session (extract name before the parenthesis)
    session_name=$(echo "$choice" | sed 's/ (.*//')
    exec $TMUX attach-session -t "=$session_name"
fi
